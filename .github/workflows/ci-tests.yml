name: CI - Tests and Validation

on:
  push:
    branches:
      - main
      - develop
      - test
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate-config:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          if [ -f "docker-compose.yml" ]; then
            docker compose -f docker-compose.yml config > /dev/null
            echo "✅ docker-compose.yml is valid"
          else
            echo "❌ docker-compose.yml not found"
            exit 1
          fi

      - name: Check required files
        run: |
          REQUIRED_FILES=(
            "Dockerfile"
            "docker-compose.yml"
            "env.example"
            "src/kna_data/config.py"
            "src/app.py"
          )
          
          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              MISSING=$((MISSING + 1))
            else
              echo "✅ Found: $file"
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo "❌ $MISSING required files are missing"
            exit 1
          fi

      - name: Validate env.example
        run: |
          if [ -f "env.example" ]; then
            echo "Checking env.example for required variables..."
            
            REQUIRED_VARS=(
              "SECRET_KEY"
              "MARIADB_HOST"
              "MARIADB_USER"
              "MARIADB_PASSWORD"
              "MARIADB_ROOT_PASSWORD"
              "DATABASE_URL"
              "DIR_RESOURCES"
              "ADMIN_PASSWORD"
            )
            
            MISSING=0
            for var in "${REQUIRED_VARS[@]}"; do
              if grep -q "^${var}=" env.example; then
                echo "✅ $var"
              else
                echo "❌ Missing: $var"
                MISSING=$((MISSING + 1))
              fi
            done
            
            if [ $MISSING -gt 0 ]; then
              echo "❌ env.example is missing $MISSING required variables"
              exit 1
            fi
            
            echo "✅ env.example contains all required variables"
          fi

  lint-python:
    name: Python Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Check code formatting with black
        run: |
          black --check --diff src/ || echo "⚠️ Code formatting issues found - run 'black src/' locally"

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ || echo "⚠️ Import sorting issues found - run 'isort src/' locally"

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: kna-history:test
          build-args: |
            APP_VERSION=ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image
        run: |
          # Start container in background
          docker run -d --name kna-test \
            -e SECRET_KEY=test-secret-key \
            -e MARIADB_HOST=test-db \
            -e MARIADB_USER=test \
            -e MARIADB_PASSWORD=test \
            -e DATABASE_URL=sqlite:///test.db \
            -e DIR_RESOURCES=/data/resources \
            -e ADMIN_PASSWORD=test \
            -p 5000:5000 \
            kna-history:test
          
          # Wait for startup
          echo "Waiting for application to start..."
          sleep 10
          
          # Check if container is still running
          if docker ps | grep -q kna-test; then
            echo "✅ Container is running"
          else
            echo "❌ Container failed to start"
            docker logs kna-test
            exit 1
          fi
          
          # Cleanup
          docker stop kna-test
          docker rm kna-test

  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Validate shell scripts
        run: |
          if ls *.sh 1> /dev/null 2>&1; then
            for script in *.sh; do
              echo "Checking $script..."
              shellcheck "$script" || echo "⚠️ Issues found in $script"
            done
          else
            echo "No shell scripts found to validate"
          fi

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-config, lint-python, test-docker-build, validate-scripts]
    if: always()
    
    steps:
      - name: Check job results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Config Validation**: ${{ needs.validate-config.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Linting**: ${{ needs.lint-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Build Test**: ${{ needs.test-docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Script Validation**: ${{ needs.validate-scripts.result }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-config.result }}" != "success" ] || \
             [ "${{ needs.lint-python.result }}" != "success" ] || \
             [ "${{ needs.test-docker-build.result }}" != "success" ] || \
             [ "${{ needs.validate-scripts.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
